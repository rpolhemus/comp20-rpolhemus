<!DOCTYPE html>

<html>
    <head>
        <title>Lift Knockoff</title>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-u0xf-Zaql2EJIo3IEtWUSzyXg2TfqZE&libraries=geometry"></script>
        <!-- TODO: Change the token for this -->
        <link rel="stylesheet" href="style.css" />
        <script>
            /* Constants */
            const API_URL = "https://hans-moleman.herokuapp.com/rides";
            const USERNAME = "cZvBHJ97";
            const ALT_CAR_IMG_LOC = "/images/weinermobile.png";
            const DEFAULT_IMG_LOC = "/images/person.png"; // TODO update to default images?
            const VEHICLE_IMG_LOC = "/images/car.png";
            const PERSON_IMG_LOC  = "/images/person.png";


            var userLat = 0;
            var userLng = 0;
            var user = new google.maps.LatLng(userLat, userLng);

            var map;
            var mapOptions = {
                zoom: 13,
                center: user,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };

            var infowindow = new google.maps.InfoWindow();

            function init() {
                map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
                getUserLocation();
            }

            //var tmpMarker; // This or in function?

            function addMarker(pos, title, text, map, icon) {
                var tmpMarker = new google.maps.Marker({
                    position: pos,
                    title: title,
                    icon: icon
                });
                tmpMarker.setMap(map);
                google.maps.event.addListener(tmpMarker, 'click', function() {
                    infowindow.setContent(text);
                    infowindow.open(map, tmpMarker);
                });

            }

            function getUserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        userLat = position.coords.latitude;
                        userLng = position.coords.longitude;
                        renderMap();
                    });
                    getOthers();
                }
                else {
                    alert("Your web browser does not support geolocation.");
                }
            }

            var othersObj;
			
			function getOthers () {
				var request = new XMLHttpRequest();
				var params = 'username=' + USERNAME + "&lat=" + userLat + "&lng=" + userLng;
                request.open('POST', API_URL, true);
                console.log("API_URL is " + API_URL);

				//Send the proper header information along with the request
				request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

				request.onreadystatechange = function() {//Call a function when the state changes.
					if(request.readyState == 4 && request.status == 200) {
						othersObj = JSON.parse(request.responseText);
                        // TODO check if error
                        console.log(othersObj);
                        renderOthers(othersObj, map);
					}
				}
				request.send(params);
			}

            var tmpMarker;
            var currLat, currLng;
            var currName;
            var othersList;
            var othersImg = DEFAULT_IMG_LOC;

            function renderOthers(others, map) {
                // TODO handle weinermobile
                if(others.vehicles != undefined) {
                    othersList = others.vehicles;
                    othersImg = VEHICLE_IMG_LOC;
                }
                else if(others.passengers != undefined) {
                    othersList = others.passengers;
                    othersImg = PERSON_IMG_LOC;
                }


                for (count = 0; count < othersList.length; count++) {
                    currName = othersList[count].username;
                    currPos  = new google.maps.LatLng(othersList[count].lat, othersList[count].lng);
                    currDist = google.maps.geometry.spherical.computeDistanceBetween(user, currPos);
                    currText = currName + "\nCurrent Distance: " + currDist;
                    console.log(currText);

                    if(currName == 'WEINERMOBILE')
                        addMarker(currPos, currName, currText, map, ALT_CAR_IMG_LOC);

                    addMarker(currPos, currName, currText, map, othersImg);
                }
            }

            function renderMap() {
                user = new google.maps.LatLng(userLat, userLng);

                map.panTo(user);

                addMarker(user, "User", "User", map);
                // marker = new google.maps.Marker({
                //     position: user,
                //     title: "This is a test"
                // });
                // marker.setMap(map);

                // google.maps.event.addListener(marker, 'click', function() {
                //     infowindow.setContent(marker.title);
                //     infowindow.open(map, marker);
                // });
                console.log("Render success");
            }
        </script>
    </head>

    <body onload="init()">
        <div id="map_canvas"></div>
    </body>

</html>