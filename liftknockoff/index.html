<!DOCTYPE html>

<html>
    <head>
        <title>Lift Knockoff</title>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-u0xf-Zaql2EJIo3IEtWUSzyXg2TfqZE"></script>
        <!-- TODO: Change the token for this -->
        <link rel="stylesheet" href="style.css" />
        <script>
            /* Constants */
            const API_URL = "https://hans-moleman.herokuapp.com/rides";
            const USERNAME = "cZvBHJ97";

            var userLat = 0;
            var userLng = 0;
            var user = new google.maps.LatLng(userLat, userLng);

            var map;
            var mapOptions = {
                zoom: 13,
                center: user,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };

            var infowindow = new google.maps.InfoWindow();

            function init() {
                map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
                getUserLocation();
            }

            var tmpMarker; // This or in function?
            function addMarker(lat, lng, title, text, map) {
                tmpMarker = new google.maps.Marker({
                    position: new google.maps.LatLng(lat, lng),
                    title: title
                });
                tmpMarker.setMap(map);
                google.maps.event.addListener(tmpMarker, 'click', function() {
                    currInfoWindow = new google.maps.InfoWindow();
                    currInfoWindow.setContent(text);
                });

            }

            function getUserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        userLat = position.coords.latitude;
                        userLng = position.coords.longitude;
                        renderMap();
                    });
                    getOthers();
                }
                else {
                    alert("Your web browser does not support geolocation.");
                }
            }

            var othersList;

            function getOthers() {
                console.log("In getOthers()");
                request = new XMLHttpRequest();

                request.open("POST", API_URL, true, USERNAME);
                request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                request.onreadystatechange = function() {
                    if (request.readyState == 4 && request.status == 200) {
                        othersList = JSON.parse(request.responseText);
                        // TODO check if error
                        console.log("About to render others");
                        renderOthers();
                        console.log("Rendered others");
                    }
                }
                request.send("username=" + USERNAME + "&lat=" + userLat + "&lng=" + userLng);
            }
			
			function getOthers () {
				var request = new XMLHttpRequest();
				var url = 'get_data.php';
				var params = 'orem=ipsum&name=binny';
				request.open('POST', url, true);

				//Send the proper header information along with the request
				request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

				request.onreadystatechange = function() {//Call a function when the state changes.
					if(request.readyState == 4 && request.status == 200) {
						alert(request.responseText);
					}
				}
				request.send(params);
			}

            var tmpMarker;
            var currLat, currLng;
            var currName;

            function renderOthers(others, map) {
                // TODO handle weinermobile
                for (count = 0; count < othersList.length; count++) {
                    currName = others[count].username;
                    currLat  = others[count].lat;
                    currLng  = others[count].lng;
                    currDist = google.maps.geometry.spherical.computeDistanceBetween(user, new google.maps.LatLng(currLat, currLng));
                    currText = currName + "\nCurrent Distance: " + currDist;

                    addMarker(currLat, currLng, currName, currText, map);
                }
            }

            function renderMap() {
                user = new google.maps.LatLng(userLat, userLng);

                map.panTo(user);

                marker = new google.maps.Marker({
                    position: user,
                    title: "This is a test"
                });
                marker.setMap(map);

                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.setContent(marker.title);
                    infowindow.open(map, marker);
                });
                console.log("Render success");
            }
        </script>
    </head>

    <body onload="init()">
        <div id="map_canvas"></div>
    </body>

</html>